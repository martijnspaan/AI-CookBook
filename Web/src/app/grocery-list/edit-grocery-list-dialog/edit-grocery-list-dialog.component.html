<app-reusable-popup
  [isVisible]="isVisible"
  [config]="popupConfig"
  (popupClosed)="closeDialog()">
  
  <ng-template #popupBody>
    <!-- Loading State -->
    <div *ngIf="isLoadingRecipes" class="loading-state">
      <div class="spinner"></div>
      <p>{{ 'GROCERY_LISTS.LOADING_RECIPES' | translate }}</p>
    </div>

    <!-- Grocery Day Display (Read-only) -->
    <div class="mb-3" *ngIf="!isLoadingRecipes">
      <label class="form-label fw-bold">{{ 'GROCERY_LISTS.GROCERY_DAY' | translate }}</label>
      <div class="form-control-plaintext bg-light p-2 rounded border">
        <i class="fas fa-calendar-alt me-2 text-muted"></i>
        {{ getFormattedGroceryDay() }}
      </div>
    </div>

    <!-- Meal Selection -->
    <div class="mb-2 flex-grow-1 d-flex flex-column" *ngIf="!isLoadingRecipes">
      <div class="mb-2">
        <label class="form-label fw-bold">{{ 'GROCERY_LISTS.SELECT_MEALS_TO_INCLUDE' | translate }}</label>
        <div *ngIf="isLoadingGroceryLists" class="text-muted small">
          <i class="fas fa-spinner fa-spin me-1"></i>
          {{ 'GROCERY_LISTS.LOADING_EXISTING_LISTS' | translate }}
        </div>
      </div>
      
      <div class="meal-selection-container">
        <div *ngFor="let dateGroup of mealsByDate" class="date-group mb-2">
          <div class="date-header">
            <h6 class="mb-1 text-primary">{{ getDisplayDate(dateGroup.date) }}</h6>
          </div>
          
          <div class="meals-list">
            <div *ngFor="let meal of dateGroup.meals" class="meal-row" [class.meal-already-used]="meal.isAlreadyUsed">
              <div class="form-check">
                <!-- Container for both checkbox and grocery cart icon to ensure same positioning -->
                <div class="form-check-input-container">
                  <!-- Show checkbox for available meals -->
                  <input 
                    *ngIf="!meal.isAlreadyUsed"
                    class="form-check-input" 
                    type="checkbox" 
                    [id]="'meal-' + meal.date + '-' + meal.mealType"
                    [(ngModel)]="meal.isSelected"
                    (change)="onMealSelectionChanged(meal)">
                  
                  <!-- Show grayed-out grocery cart icon for already used meals -->
                  <div 
                    *ngIf="meal.isAlreadyUsed"
                    class="grocery-cart-icon-disabled"
                    [id]="'meal-' + meal.date + '-' + meal.mealType">
                    <i class="fas fa-shopping-cart"></i>
                  </div>
                </div>
                
                <label 
                  class="form-check-label d-flex align-items-center justify-content-between w-100" 
                  [for]="'meal-' + meal.date + '-' + meal.mealType"
                  [class.text-muted]="meal.isAlreadyUsed">
                  <span class="recipe-name">
                    {{ meal.recipeTitle }}
                  </span>
                  <span class="badge" [class.bg-primary]="!meal.isAlreadyUsed" [class.bg-secondary]="meal.isAlreadyUsed">
                    {{ getMealTypeLabel(meal.mealType) }}
                  </span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div *ngIf="mealSelections.length === 0 && !isLoadingRecipes" class="text-muted text-center py-3">
        <i class="fas fa-info-circle me-2"></i>
        {{ 'GROCERY_LISTS.NO_MEALS_IN_LIST' | translate }}
      </div>
    </div>
  </ng-template>

  <ng-template #popupFooter>
    <button 
      type="button" 
      class="btn btn-success" 
      [disabled]="getSelectedMealsCount() === 0 || isUpdating"
      (click)="updateGroceryList()">
      <i class="fas fa-spinner fa-spin me-2" *ngIf="isUpdating"></i>
      <i class="fas fa-save me-2" *ngIf="!isUpdating"></i>
      {{ isUpdating ? ('GROCERY_LISTS.UPDATING' | translate) : ('GROCERY_LISTS.UPDATE_GROCERY_LIST' | translate) }}
    </button>
  </ng-template>
</app-reusable-popup>
